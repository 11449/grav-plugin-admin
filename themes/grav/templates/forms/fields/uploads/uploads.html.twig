{% set value = (value is null ? field.default : value) %}

<div class="form-field">
    <div class="form-data form-uploads-wrapper">
        <h3>{{ field.label }}</h3>
        <div id="gravDropzone" class="dropzone"></div>
        <span>{{ value|join("\n") }}</span>
        <script>
            $(function(){
                var URI = $('[data-media-url]').data('media-url'), thisDropzone,
                    modalError = function(args){
                        if (args.data.status == 'error'){

                            if (args.mode == 'addBack'){
                                // let's add back the file
                                if (args.file instanceof File) this.addFile(args.file);
                                else {
                                    this.files.push(args.file);
                                    this.options.addedfile.call(this, args.file);
                                    this.options.thumbnail.call(this, args.file, args.file.extras.url);
                                }
                            } else if (args.mode == 'removeFile') {
                                this.removeFile(args.file);
                            }

                            // fire up the modal
                            var modalContainer = $('[data-remodal-id=generic]');
                            modalContainer.find('.error-content').html(args.msg);
                            $.remodal.lookup[modalContainer.data('remodal')].open();
                        }
                    };
                Dropzone.autoDiscover = false;
                Dropzone.options.gravDropzone = {
                    addRemoveLinks: true,
                    acceptedFiles: $('[data-media-types]').data('media-types'),
                    init: function() {
                        thisDropzone = this;
                        $.get(URI + '/task:listmedia', function(data) {
                            $.each(data, function(filename, data){
                                var mockFile = { name: filename, size: data.size, accepted: true, extras: data };
                                thisDropzone.files.push(mockFile);
                                thisDropzone.options.addedfile.call(thisDropzone, mockFile);
                                thisDropzone.options.thumbnail.call(thisDropzone, mockFile, data.url);
                            });

                            $('.dz-preview').prop('draggable', 'true');
                        });

                        this.on("complete", function(file) {
                            if (file.accepted) {
                                $('.dz-preview').prop('draggable', 'true');
                                return;
                            }
                            var data = {status: 'error', message: 'Unsupported file type: ' + file.name.match(/\..+/).join('')};
                            $.proxy(modalError, this, {
                                file: file,
                                data: data,
                                mode: 'removeFile',
                                msg: '<p>An error occurred while trying to add the file <strong>'+file.name+'</strong></p><pre>'+data.message+'</pre>'
                            })();
                        });

                        this.on('success', function(file, response){
                            thisDropzone = this;
                            $.proxy(modalError, this, {
                                file: file,
                                data: response,
                                mode: 'removeFile',
                                msg: '<p>An error occurred while trying to upload the file <strong>'+file.name+'</strong></p><pre>'+response.message+'</pre>'
                            })();
                        });

                        this.on('removedfile', function(file) {
                            if (!file.accepted) return;
                            thisDropzone = this;
                            $.post(URI + '/task:delmedia', {filename: file.name}, function(data){
                                $.proxy(modalError, thisDropzone, {
                                    file: file,
                                    data: data,
                                    mode: 'addBack',
                                    msg: '<p>An error occurred while trying to remove the file <strong>'+file.name+'</strong></p><pre>'+data.message+'</pre>'
                                })();
                            });
                        });
                    }
                };

                var dropzone = new Dropzone("#gravDropzone", { url: URI + '/task:addmedia', createImageThumbnails: { thumbnailWidth: 150} });

                $("#gravDropzone").delegate('.dz-preview', 'dragstart', function(e){
                    var uri = $(this).find('.dz-filename').text(), shortcode = '![](' + uri + ')';
                    dropzone.disable();
                    $(this).addClass('hide-backface');
                    e.originalEvent.dataTransfer.effectAllowed = 'copy';
                    e.originalEvent.dataTransfer.setData('text', shortcode);
                });

                $("#gravDropzone").delegate('.dz-preview', 'dragend', function(e){
                    dropzone.enable();
                    $(this).removeClass('hide-backface');
                });
            });
        </script>
    </div>
</div>
